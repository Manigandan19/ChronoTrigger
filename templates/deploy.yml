parameters:
  - name: environment
    type: string
  - name: dependsOn
    type: object
    default: ['deploy_to_test']
  - name: condition
    type: string
    default: 'succeeded()'

stages:
  - stage: deploy_to_${{parameters.environment}}
    displayName: Deploy to ${{parameters.environment}}
    dependsOn:
      - Build
      - ${{ parameters.dependsOn }}
    condition: ${{ parameters.condition }}
    jobs:
      - deployment: Deploy
        variables:
          chrono.tag: $[stageDependencies.Build.Build.outputs['GetPackageVersion.chrono.tag']]
        displayName: Deploy to ${{parameters.environment}}
        pool:
          vmImage: ubuntu-latest
        environment:
          name: ${{parameters.environment}}
      - job: PulumiDeploy
        pool:
          vmImage: ubuntu-latest
        steps:
        - task: Npm@1 
           # Install dependencies
        - script: npm install
          workingDirectory: $(System.DefaultWorkingDirectory)
          displayName: "Install linting, test and coverage dependencies"

           # Deploy Pulumi 
        - script:  pulumi stack select dev --create
          env:
           PULUMI_ACCESS_TOKEN: $(pulumi.access.token)
        - script: pulumi config set azure-native:location $(arm.location)
          env:
           PULUMI_ACCESS_TOKEN: $(pulumi.access.token)
        - script: npm run pulumi-preview:${{parameters.environment}}
          env:
            PULUMI_ACCESS_TOKEN: $(pulumi.access.token)
            ARM_CLIENT_ID: $(arm.client.id)
            ARM_CLIENT_SECRET: $(arm.client.secret)
            ARM_TENANT_ID: $(arm.tenant.id)
            ARM_SUBSCRIPTION_ID: $(arm.subscription.id)
